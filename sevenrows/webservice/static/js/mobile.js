define(["globals","log","lib/event","cookie","doTimeout"],function(e,t,n){t.module("controller/mobile");var r={is:!1,isTablet:!1,isDesktop:!1,init:function(){r.check(!0),n.on("resize orientationchange",function(){r.check(!1)}),r.IOS_APP_PROMO=!!e.IOS_APP_PROMO,r.isIPHONE=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)?!0:!1,r.isIPAD=navigator.userAgent.match(/iPad/i)?!0:!1,r.isIOS=r.isIPHONE||r.isIPAD?!0:!1,r.isAndroid=navigator.userAgent.match(/android/i)?!0:!1,r.viewportmeta=document.querySelector&&document.querySelector('meta[name="viewport"]'),r.ua=navigator.userAgent,r.isIPHONE&&$("html").addClass("iphone"),r.IOS_APP_PROMO&&r.ad.init(),n.on("resize orientationchange",function(){$.doTimeout("mobileappcheck",100,function(){r.adjustWidth(),r.faceFix()})}),r.adjustWidth(),n.ready("just_became_mobile",function(){r.hideUrlBar(),r.faceFix(),r.scaleFix(),document.addEventListener&&document.addEventListener("click",r.ghostClickHandler,!0),$(".mobilefooter .menu-toggle").removeClass("menu-toggle")}),n.everReady("just_became_mobile",function(){$(".ui-dialog").find(".ui-dialog-content").dialog("close")}),n.everReady("just_became_desktop",function(){$(".ui-dialog").find(".ui-dialog-content").dialog("close")}),r.isActuallyDesktop()?$("html").addClass("actually_desktop"):($("html").addClass("actually_mobile"),r.isIOS||$("#footer").find(".ios-footer").hide())},check:function(e){if(!e||typeof e=="object")e=!1;r.isTouch=Modernizr.touch;var i=Modernizr.mq("only screen and (max-width: 480px)")||Modernizr.mq("only screen and (max-width: 640px) and (-webkit-min-device-pixel-ratio: 1.25)")||Modernizr.mq("only screen and (max-width: 640px) and (min-resolution: 120dpi)");if(i){var s=r.is?!1:!0;s&&t("JUST BECAME MOBILE"),r.is=!0;if(s||e)$("html").removeClass("desktop tablet").addClass("mobile"),n.trigger("just_became_mobile")}else r.is=!1;r.isTablet=Modernizr.mq("only screen and (min-width: 481px) and (max-width: 1024px)")||Modernizr.mq("only screen and (min-width: 641px) and (max-width: 1024px) and (-webkit-min-device-pixel-ratio: 1.25)")||Modernizr.mq("only screen and (min-width: 641px) and (max-width: 1024px) and (min-resolution: 120dpi)");var i=!r.is;if(i){var s=r.isDesktop?!1:!0;s&&t("JUST BECAME DESKTOP"),r.isDesktop=!0;if(s||e)$("html").removeClass("mobile tablet").addClass("desktop"),n.trigger("just_became_desktop")}else r.isDesktop=!1},ad:{init:function(){r.isIPHONE===!0&&r.iOSversion>5&&r.ad.setup()},iOSversion:function(){if(/iP(hone|od|ad)/.test(navigator.platform)){var e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3]||0,10)]}},setup:function(){var e=$.cookie("show_ios_banner")==="true"?"open":"pig",t="";t+='<div class="ios-ad">',t+='<h2>Get the <span class="text white">about</span><span class="text orange">.</span>me app on your <span class="text white">iPhone</span>.</h2>',t+='<div class="ios-ad-more '+e+'">',t+="<p>Connect with friends and discover people nearby.</p>",t+='<a href="http://itunes.apple.com/us/app/about.me-for-iphone/id500230347" class="button button-submit dark blue km-mobile-banner"><span class="button-content">Download the Free App</a><span class="not-now">Not Now</span>',t+="</div>",t+="</div>",$(".profilepage").prepend(t),$(".ios-ad h2, .ios-ad-more .not-now, .ios-ad-more .button").on("click",r.ad.toggle)},toggle:function(){$(".ios-ad-more").slideToggle(function(){$(this).toggleClass("open");if($(this).hasClass("open"))var e=!0;else var e=!1;$.cookie("show_ios_banner",e,{expires:365,path:"/"})})}},orientation:0,scrollPos:0,iframeSheet:function(){var e=document.getElementsByTagName("head")[0],t=document.createElement("style");t.setAttribute("type","text/css"),e.appendChild(t);var n=t.sheet;return n},setiframeWidth:function(){var e=r.iframeSheet();e&&(e.rules&&e.rules.length&&e.deleteRule(0),e.insertRule(".app-container iframe, .services_modal { width:"+r.width+"px !important; }",0))},adjustWidth:function(){r.width=Math.min($(window).width(),580),r.setiframeWidth()},dialogStateToggle:function(){t("dialogStateToggle");if(!r.is)return;var e=$(".ui-dialog:visible");e.length?$(window).scrollTop(0):$(window).scrollTop(r.scrollPos)},faceFix:function(){var e=$(".mobile-bg-test-img"),t=e.height(),n=e.width(),r=t/n,i=$(window).width()*r;r>=1?$(".mobile-background-container").height(i/1.5):$(".mobile-background-container").height(i)},scaleFix:function(){r.viewportmeta&&/iPhone|iPad/.test(r.ua)&&!/Opera Mini/.test(r.ua)&&(r.viewportmeta.content="width=device-width, minimum-scale=1.0, maximum-scale=1.0",document.addEventListener("gesturestart",r.gestureStart,!1))},gestureStart:function(){r.viewportmeta.content="width=device-width, minimum-scale=0.25, maximum-scale=1.6"},hideUrlBar:function(){var e=window,t=e.document;if(!location.hash&&e.addEventListener){e.scrollTo(0,1);var n=1,r=function(){return e.pageYOffset||t.compatMode==="CSS1Compat"&&t.documentElement.scrollTop||t.body.scrollTop||0},i=setInterval(function(){t.body&&(clearInterval(i),n=r(),e.scrollTo(0,n===1?0:1))},15);e.addEventListener("load",function(){setTimeout(function(){r()<20&&e.scrollTo(0,n===1?0:1)},0)},!1)}},fastButton:function(e,t){this.element=e,this.handler=t,e.addEventListener&&(e.addEventListener("touchstart",this,!1),e.addEventListener("click",this,!1))},preventGhostClick:function(e,t){r.coords.push(e,t),window.setTimeout(function(){r.coords.splice(0,2)},2500)},ghostClickHandler:function(e){for(var t=0,n=r.coords.length;t<n;t+=2){var i=r.coords[t],s=r.coords[t+1];Math.abs(e.clientX-i)<25&&Math.abs(e.clientY-s)<25&&(e.stopPropagation(),e.preventDefault())}},coords:[],splash:function(){var e=navigator.platform==="iPad"?"h/":"l/";document.write('<link rel="apple-touch-startup-image" href="/img/'+e+'splash.png" />')},autogrow:function(e,t){function n(e){var t=this.scrollHeight,n=this.clientHeight;t>n&&(this.style.height=t+3*i+"px")}var r=t?t:12,i=e.currentStyle?e.currentStyle.lineHeight:getComputedStyle(e,null).lineHeight;i=i.indexOf("px")==-1?r:parseInt(i,10),e.style.overflow="hidden",e.addEventListener?e.addEventListener("keyup",n,!1):e.attachEvent("onkeyup",n)}};return r.isActuallyDesktop=function(){return!function(e){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))return!0}(navigator.userAgent||navigator.vendor||window.opera)},r.fastButton.prototype.handleEvent=function(e){switch(e.type){case"touchstart":this.onTouchStart(e);break;case"touchmove":this.onTouchMove(e);break;case"touchend":this.onClick(e);break;case"click":this.onClick(e)}},r.fastButton.prototype.onTouchStart=function(e){e.stopPropagation(),this.element.addEventListener("touchend",this,!1),document.body.addEventListener("touchmove",this,!1),this.startX=e.touches[0].clientX,this.startY=e.touches[0].clientY,this.element.style.backgroundColor="rgba(0,0,0,.7)"},r.fastButton.prototype.onTouchMove=function(e){(Math.abs(e.touches[0].clientX-this.startX)>10||Math.abs(e.touches[0].clientY-this.startY)>10)&&this.reset()},r.fastButton.prototype.onClick=function(e){e.stopPropagation(),this.reset(),this.handler(e),e.type=="touchend"&&r.preventGhostClick(this.startX,this.startY),this.element.style.backgroundColor=""},r.fastButton.prototype.reset=function(){this.element.removeEventListener("touchend",this,!1),document.body.removeEventListener("touchmove",this,!1),this.element.style.backgroundColor=""},$(document).ready(r.init),r});